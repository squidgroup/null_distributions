---
title: Results from Permutation Test and Bootstrap Simulations
author: Joel Pick
output: html_document
---

# Comparing bootstrap and permutation tests
```{r,echo=FALSE}

rm(list=ls())

library(scales)
library(beeswarm)

wd <- "~/github/bayes_perm/"

source(paste0(wd,"R/00_functions.R"))


files <- list.files(paste0(wd,"Data/Intermediate"))
results <- files[grep("gaus_sims",files)]
list_names <- gsub("gaus_sims_|.Rdata","",results)

actual<-as.data.frame(do.call(rbind,lapply(results, function(y){
	load(paste0(wd,"Data/Intermediate/",y))
	do.call(rbind,lapply(out, function(x){
	  z <- c(x$param,x$summary)
	  # ICC=x$ICC,N_group=x$N_group, N_within=x$N_within
	  names(z) <- c("pop","ICC","N_group","N_within","freq","mode0.1","mode1","median","mean","LCI","UCI","ESS")	
	  z
	}))
} )))


files_p <- list.files(paste0(wd,"Data/Intermediate"))
results_p <- files_p[grep("gaus_perm",files_p)]
list_names_p <- gsub("gaus_perm_|.Rdata","",results_p)

results_b <- files[grep("gaus_boot",files)]
list_names_b <- gsub("gaus_boot_|.Rdata","",results_b)

p_perm<-as.data.frame(do.call(rbind,lapply(results_p, function(i){
  load(paste0(wd,"Data/Intermediate/",i))
  t(sapply(perm_out, function(x){
		names(x$param) <-c("pop", "ICC", "N_group", "N_within")
		c(x$param,
		freq_perm = p_func(x$actual["freq"],x$perm[,"freq"]),
		mean_perm = p_func(x$actual["mean"],x$perm[,"mean"]),
		median_perm = p_func(x$actual["median"],x$perm[,"median"]),
		mode0.1_perm = p_func(x$actual["mode0.1"],x$perm[,"mode0.1"]),
		mode1_perm = p_func(x$actual["mode1"],x$perm[,"mode1"])
		)
	}))
})))

p_boot<-as.data.frame(do.call(rbind,lapply(results_b, function(i){
  load(paste0(wd,"Data/Intermediate/",i))
  t(sapply(boot_out, function(x){
		c(
		freq_boot = p_func(x$actual["freq"],x$boot[,"freq"]),
		mean_boot = p_func(x$actual["mean"],x$boot[,"mean"]),
		median_boot = p_func(x$actual["median"],x$boot[,"median"]),
		mode0.1_boot = p_func(x$actual["mode0.1"],x$boot[,"mode0.1"]),
		mode1_boot = p_func(x$actual["mode1"],x$boot[,"mode1"])
		)
	}))
})))


all<-cbind(p_perm,p_boot)


pch=19
cex=0.2
col=alpha(1,0.3)
```

P-values calculated by either method are highly correlated, regardless of which measure is used. 

```{r,'perm-boot-plot',echo=FALSE, fig.height=6}
## permutation to bootstrap p-values
{par(mfrow=c(2,2))
plot(mean_perm~mean_boot,all, pch=pch, cex=cex, col=col)
abline(0,1, col="red")
text(0.1,0.9,round(cor(all[,"mean_boot"],all[,"mean_perm"]),3))

plot(median_perm~median_boot,all, pch=pch, cex=cex, col=col)
abline(0,1, col="red")
text(0.1,0.9,round(cor(all[,"median_boot"],all[,"median_perm"]),3))

plot(mode1_perm~mode1_boot,all, pch=pch, cex=cex, col=col)
abline(0,1, col="red")
text(0.1,0.9,round(cor(all[,"mode1_boot"],all[,"mode1_perm"]),3))

plot(mode0.1_perm~mode0.1_boot,all, pch=pch, cex=cex, col=col)
abline(0,1, col="red")
text(0.1,0.9,round(cor(all[,"mode0.1_boot"],all[,"mode0.1_perm"]),3))
}
```

This translates into very similar power across the bootstrapping and permutations tests, with slightly higher power in permutation tests, and neither show worryingly high or low higher type 1 error

```{r,'power-pb-plot',echo=FALSE, fig.height=12}

{
ICCs <- c(0,0.1,0.2,0.4)
	power_dat <- aggregate(cbind(mode1_boot,mode0.1_boot,mean_boot,median_boot,median_perm)~N_group+ N_within+ICC,all,function(x) mean(x<0.05))
par(mfrow=c(2,1),mar=c(4,4,2,1), cex.axis=0.75, mgp=c(2,0.5,0))
plot(NA,xlim=c(20,80),xlab="Number of Groups", ylab="Power",  ylim=c(0,1),)
abline(h=0.05, col="grey")
legend("topleft",c("perm","boot","ICC=0","ICC=0.1","ICC=0.2","ICC=0.4"), pch=c(18,19,rep(NA,4)), col=c("grey","grey",1:4),pt.bg=c("grey"), lty=c(0,0,1,1,1,1),lwd=2)

# abline(h=c(0.025,0.075), col="grey")
for(j in seq_along(ICCs)){
	points(median_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==2, col=j, pch=19, type="b")
	points(median_perm~N_group,power_dat, subset=ICC==ICCs[j]&N_within==2, col=j, pch=18, type="b")

	# points(mode0.1_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==2, col=j, pch=18, type="b")
	# 	points(mode1_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==2, col=j, pch=17, type="b")

	# lines(mean_boot~N_group,power_dat, subset=ICC==ICCs[j], col=j, lwd=2)
}

plot(NA,xlim=c(20,80),xlab="Number of Groups", ylab="Power",  ylim=c(0,1))
abline(h=0.05, col="grey")
# abline(h=c(0.028,0.081), col="grey")
for(j in seq_along(ICCs)){
	points(median_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==4, col=j, pch=19, type="b")
		points(median_perm~N_group,power_dat, subset=ICC==ICCs[j]&N_within==4, col=j, pch=18, type="b")

		# points(mode0.1_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==4, col=j, pch=18, type="b")

	# lines(mean_boot~N_group,power_dat, subset=ICC==ICCs[j], col=j, lwd=2)
}
}
```

# Comparing measures

P-values calculated using mean and median are highly correlated. Also high correlation with Mode1, but much lower with mode0.1 , and equally between the two mode measures.

```{r,'diff-measures-plot',echo=FALSE, fig.height=12}
# comparison between different measures
{
par(mfrow=c(4,2))
plot(mean_boot~median_boot,all, pch=pch, cex=cex, col=col)
abline(0,1, col="red")
text(0.1,0.9,round(cor(all[,"mean_boot"],all[,"median_boot"]),3))
plot(mean_perm~median_perm,all, pch=pch, cex=cex, col=col)
abline(0,1, col="red")
text(0.1,0.9,round(cor(all[,"mean_perm"],all[,"median_perm"]),3))

plot(mean_boot~mode1_boot,all, pch=pch, cex=cex, col=col)
abline(0,1, col="red")
text(0.1,0.9,round(cor(all[,"mean_boot"],all[,"mode1_boot"]),3))
plot(mean_perm~mode1_perm,all, pch=pch, cex=cex, col=col)
abline(0,1, col="red")
text(0.1,0.9,round(cor(all[,"mean_perm"],all[,"mode1_perm"]),3))


plot(mean_boot~mode0.1_boot,all, pch=pch, cex=cex, col=col)
abline(0,1, col="red")
text(0.1,0.9,round(cor(all[,"mean_boot"],all[,"mode0.1_boot"]),3))
plot(mean_perm~mode0.1_perm,all, pch=pch, cex=cex, col=col)
abline(0,1, col="red")
text(0.1,0.9,round(cor(all[,"mean_perm"],all[,"mode0.1_perm"]),3))


plot(mode1_boot~mode0.1_boot,all, pch=pch, cex=cex, col=col)#col=alpha(1:4,0.3)[as.factor(all$N_group)])
abline(0,1, col="red")
text(0.1,0.9,round(cor(all[,"mode1_boot"],all[,"mode0.1_boot"]),3))
plot(mode1_perm~mode0.1_perm,all, pch=pch, cex=cex, col=col)
abline(0,1, col="red")
text(0.1,0.9,round(cor(all[,"mode1_perm"],all[,"mode0.1_perm"]),3))

}

```


Generally similar power with all measures, with the exception of mode0.1, which gives consistently lower power. Interestingly, mode1 has slightly higher power than the mean and median at very low sample sizes

```{r,'power-measures-plot',echo=FALSE, fig.height=12}
{
ICCs <- c(0,0.1,0.2,0.4)
	power_dat <- aggregate(cbind(mode1_boot,mode0.1_boot,mean_boot,median_boot,median_perm)~N_group+ N_within+ICC,all,function(x) mean(x<0.05))
par(mfrow=c(2,1),mar=c(4,4,2,1), cex.axis=0.75, mgp=c(2,0.5,0))
plot(NA,xlim=c(20,80),xlab="Number of Groups", ylab="Power",  ylim=c(0,1))
abline(h=0.05, col="grey")
# abline(h=c(0.025,0.075), col="grey")
legend("topleft",c("median","mean","mode1","mode0.1","ICC=0","ICC=0.1","ICC=0.2","ICC=0.4"), pch=c(18,19,17,15,rep(NA,4)), col=c(rep("grey",4),1:4),pt.bg=c("grey"), lty=c(0,0,0,0,1,1,1,1),lwd=2)

for(j in seq_along(ICCs)){
	points(mean_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==2, col=j, pch=19, type="b")
	points(median_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==2, col=j, pch=18, type="b")
	points(mode1_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==2, col=j, pch=17, type="b")
	points(mode0.1_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==2, col=j, pch=15, type="b")

	# lines(mean_boot~N_group,power_dat, subset=ICC==ICCs[j], col=j, lwd=2)
}

	plot(NA,xlim=c(20,80),xlab="Number of Groups", ylab="Power",  ylim=c(0,1))
	abline(h=0.05, col="grey")
	# abline(h=c(0.028,0.081), col="grey")
	for(j in seq_along(ICCs)){
		points(mean_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==4, col=j, pch=19, type="b")
		points(median_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==4, col=j, pch=18, type="b")
		points(mode1_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==4, col=j, pch=17, type="b")
		points(mode0.1_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==4, col=j, pch=15, type="b")
	# lines(mean_boot~N_group,power_dat, subset=ICC==ICCs[j], col=j, lwd=2)
	}
}


```



```{r, 'power-all-plot', echo=FALSE, fig.height=12}

power_dist <- NULL

within_groups <- c(2,4)
Ns <- c(20,40,80)
ICCs <- c(0.1,0.2,0.4)


for(i in ICCs){
	for(j in Ns){
		for(k in within_groups){
			null <- subset(actual, ICC==0 & N_within==k & N_group==j)$median
			alt <- subset(actual, N_within==k & N_group==j & ICC==i)$median
			power_dist<- rbind(power_dist,c(ICC=i, N_group=j, N_within=k, power=mean(sapply(alt, function(x) p_func(x,null))<0.05)))
		}
	}
}
power_dist <- as.data.frame(power_dist)


{
ICCs <- c(0,0.1,0.2,0.4)
	power_dat <- aggregate(cbind(mode1_boot,mode0.1_boot,mean_boot,median_boot,median_perm)~N_group+ N_within+ICC,all,function(x) mean(x<0.05))
par(mfrow=c(2,1),mar=c(4,4,2,1), cex.axis=0.75, mgp=c(2,0.5,0))
plot(NA,xlim=c(20,80),xlab="Number of Groups", ylab="Power",  ylim=c(0,1),)
abline(h=0.05, col="grey")
legend("topleft",c("power","perm","boot","ICC=0","ICC=0.1","ICC=0.2","ICC=0.4"), pch=c(17,18,19,rep(NA,4)), col=c("grey","grey","grey",1:4),pt.bg=c("grey"), lty=c(0,0,0,1,1,1,1),lwd=2)

# abline(h=c(0.025,0.075), col="grey")
for(j in seq_along(ICCs)){
	points(median_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==2, col=j, pch=19, type="b")
	points(median_perm~N_group,power_dat, subset=ICC==ICCs[j]&N_within==2, col=j, pch=18, type="b")
		points(power~N_group,power_dist, subset=ICC==ICCs[j]&N_within==2, col=j, pch=17, type="b")
}

plot(NA,xlim=c(20,80),xlab="Number of Groups", ylab="Power",  ylim=c(0,1))
abline(h=0.05, col="grey")
# abline(h=c(0.028,0.081), col="grey")
for(j in seq_along(ICCs)){
	points(median_boot~N_group,power_dat, subset=ICC==ICCs[j]&N_within==4, col=j, pch=19, type="b")
		points(median_perm~N_group,power_dat, subset=ICC==ICCs[j]&N_within==4, col=j, pch=18, type="b")
		points(power~N_group,power_dist, subset=ICC==ICCs[j]&N_within==4, col=j, pch=17, type="b")
}
}

```



```{r}
actual$mode1_bias<-actual$mode1-actual$ICC
bias<-aggregate(mode1_bias~ICC+N_group+N_within,actual,mean)
power_dat <- aggregate(mode1_boot~ICC+N_group+ N_within,all,function(x) mean(x<0.05))

plot(power_dat$mode1_boot,bias$mode1_bias, pch=19, col=c(1:4)[as.factor(power_dat$ICC)])

```